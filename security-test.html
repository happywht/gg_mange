<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®‰å…¨å‡çº§éªŒè¯æµ‹è¯•</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f3f4f6;
            padding: 20px;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
        }
        h1 {
            color: #1f2937;
            margin-bottom: 20px;
        }
        .test-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .test-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        .test-title {
            font-size: 18px;
            font-weight: 600;
            color: #374151;
        }
        .status {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
        }
        .status.pending { background: #fef3c7; color: #92400e; }
        .status.running { background: #dbeafe; color: #1e40af; }
        .status.passed { background: #d1fae5; color: #065f46; }
        .status.failed { background: #fee2e2; color: #991b1b; }
        .test-details {
            font-size: 14px;
            color: #6b7280;
            line-height: 1.6;
        }
        .run-all-btn {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 20px;
        }
        .run-all-btn:hover {
            background: #2563eb;
        }
        .summary {
            background: #1f2937;
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
        }
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 16px;
            margin-top: 12px;
        }
        .summary-item {
            text-align: center;
        }
        .summary-value {
            font-size: 32px;
            font-weight: 700;
        }
        .summary-label {
            font-size: 14px;
            color: #9ca3af;
            margin-top: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”’ å®‰å…¨å‡çº§éªŒè¯æµ‹è¯•</h1>

        <div class="summary">
            <div>æµ‹è¯•è¿›åº¦æ¦‚è§ˆ</div>
            <div class="summary-grid">
                <div class="summary-item">
                    <div class="summary-value" id="totalTests">0</div>
                    <div class="summary-label">æ€»æµ‹è¯•æ•°</div>
                </div>
                <div class="summary-item">
                    <div class="summary-value" id="passedTests">0</div>
                    <div class="summary-label">é€šè¿‡</div>
                </div>
                <div class="summary-item">
                    <div class="summary-value" id="failedTests">0</div>
                    <div class="summary-label">å¤±è´¥</div>
                </div>
            </div>
        </div>

        <button class="run-all-btn" onclick="runAllTests()">â–¶ï¸ è¿è¡Œæ‰€æœ‰æµ‹è¯•</button>

        <div id="testResults"></div>
    </div>

    <!-- Supabase é…ç½® -->
    <script src="supabase-config.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="auth-manager.js"></script>

    <script>
        const tests = [
            {
                id: 'supabase-config',
                title: 'Supabase é…ç½®æ£€æŸ¥',
                run: async () => {
                    if (typeof window.SUPABASE_URL === 'undefined') {
                        return { passed: false, message: 'SUPABASE_URL æœªå®šä¹‰' };
                    }
                    if (typeof window.SUPABASE_ANON_KEY === 'undefined') {
                        return { passed: false, message: 'SUPABASE_ANON_KEY æœªå®šä¹‰' };
                    }
                    if (typeof supabase === 'undefined') {
                        return { passed: false, message: 'Supabase SDK æœªåŠ è½½' };
                    }
                    return { passed: true, message: `Supabase é…ç½®æ­£ç¡® (${window.SUPABASE_URL})` };
                }
            },
            {
                id: 'supabase-connection',
                title: 'Supabase è¿æ¥æµ‹è¯•',
                run: async () => {
                    try {
                        const client = supabase.createClient(window.SUPABASE_URL, window.SUPABASE_ANON_KEY);
                        const { data, error } = await client.from('config').select('id').limit(1);
                        if (error) throw error;
                        return { passed: true, message: 'æˆåŠŸè¿æ¥åˆ° Supabase æ•°æ®åº“' };
                    } catch (e) {
                        return { passed: false, message: `è¿æ¥å¤±è´¥: ${e.message}` };
                    }
                }
            },
            {
                id: 'auth-manager',
                title: 'è®¤è¯ç®¡ç†å™¨æ£€æŸ¥',
                run: async () => {
                    if (typeof window.SupabaseAuth === 'undefined') {
                        return { passed: false, message: 'SupabaseAuth æœªåŠ è½½' };
                    }
                    const methods = ['signIn', 'signUp', 'logout', 'getSession', 'isAuthenticated'];
                    const missing = methods.filter(m => typeof window.SupabaseAuth[m] !== 'function');
                    if (missing.length > 0) {
                        return { passed: false, message: `ç¼ºå°‘æ–¹æ³•: ${missing.join(', ')}` };
                    }
                    return { passed: true, message: 'è®¤è¯ç®¡ç†å™¨å·²æ­£ç¡®åŠ è½½' };
                }
            },
            {
                id: 'rls-policies',
                title: 'RLS ç­–ç•¥æ£€æŸ¥',
                run: async () => {
                    try {
                        const client = supabase.createClient(window.SUPABASE_URL, window.SUPABASE_ANON_KEY);
                        // å°è¯•æœªè®¤è¯è®¿é—®ï¼ˆåº”è¯¥å¤±è´¥æˆ–è¿”å›ç©ºï¼‰
                        const { data, error } = await client.from('accounts').select('*').limit(1);
                        // å¦‚æœæœ‰é”™è¯¯æˆ–è¿”å›ç©ºï¼Œè¯´æ˜RLSå¯èƒ½åœ¨å·¥ä½œ
                        if (error && error.message.includes('policy')) {
                            return { passed: true, message: 'RLS ç­–ç•¥å·²å¯ç”¨å¹¶é˜»æ­¢æœªè®¤è¯è®¿é—®' };
                        }
                        // å¦‚æœè¿”å›ç©ºæ•°æ®ï¼Œå¯èƒ½æ˜¯æ­£å¸¸çš„ï¼ˆæ²¡æœ‰æƒé™ï¼‰
                        if (!data || data.length === 0) {
                            return { passed: true, message: 'RLS ç­–ç•¥å¯èƒ½å·²å¯ç”¨ï¼ˆè¿”å›ç©ºæ•°æ®ï¼‰' };
                        }
                        // å¦‚æœè¿”å›äº†æ•°æ®ï¼Œè¯´æ˜RLSå¯èƒ½æ²¡é…ç½®å¥½
                        return { passed: false, message: 'è­¦å‘Šï¼šæœªè®¤è¯ç”¨æˆ·å¯ä»¥è®¿é—®æ•°æ®ï¼ŒRLSå¯èƒ½æœªæ­£ç¡®é…ç½®' };
                    } catch (e) {
                        return { passed: false, message: `æ£€æŸ¥å¤±è´¥: ${e.message}` };
                    }
                }
            },
            {
                id: 'encryption-functions',
                title: 'åŠ å¯†å‡½æ•°æ£€æŸ¥',
                run: async () => {
                    try {
                        const client = supabase.createClient(window.SUPABASE_URL, window.SUPABASE_ANON_KEY);
                        // å°è¯•è°ƒç”¨åŠ å¯†å‡½æ•°
                        const { data, error } = await client.rpc('encrypt_secret', {
                            secret: 'test',
                            key: 'ChangeMe123!@#'
                        });
                        if (error) {
                            return { passed: false, message: `åŠ å¯†å‡½æ•°ä¸å¯ç”¨: ${error.message}` };
                        }
                        return { passed: true, message: 'åŠ å¯†å‡½æ•°å¯ç”¨ï¼ˆpgcryptoå·²å¯ç”¨ï¼‰' };
                    } catch (e) {
                        return { passed: false, message: `æ£€æŸ¥å¤±è´¥: ${e.message}` };
                    }
                }
            },
            {
                id: 'audit-log-table',
                title: 'å®¡è®¡æ—¥å¿—è¡¨æ£€æŸ¥',
                run: async () => {
                    try {
                        const client = supabase.createClient(window.SUPABASE_URL, window.SUPABASE_ANON_KEY);
                        const { data, error } = await client.from('audit_logs').select('id').limit(1);
                        if (error && error.code === '42P01') {
                            return { passed: false, message: 'å®¡è®¡æ—¥å¿—è¡¨ä¸å­˜åœ¨' };
                        }
                        return { passed: true, message: 'å®¡è®¡æ—¥å¿—è¡¨å·²åˆ›å»º' };
                    } catch (e) {
                        return { passed: false, message: `æ£€æŸ¥å¤±è´¥: ${e.message}` };
                    }
                }
            },
            {
                id: 'session-check',
                title: 'ä¼šè¯çŠ¶æ€æ£€æŸ¥',
                run: async () => {
                    try {
                        const session = await window.SupabaseAuth.getSession();
                        if (session) {
                            return { passed: true, message: `å·²ç™»å½•: ${session.user.email}` };
                        }
                        return { passed: true, message: 'æœªç™»å½•ï¼ˆæ­£å¸¸çŠ¶æ€ï¼‰' };
                    } catch (e) {
                        return { passed: false, message: `æ£€æŸ¥å¤±è´¥: ${e.message}` };
                    }
                }
            }
        ];

        let testResults = {};

        function renderTest(test, result = null) {
            const statusClass = result ? (result.passed ? 'passed' : 'failed') : 'pending';
            const statusText = result ? (result.passed ? 'âœ“ é€šè¿‡' : 'âœ— å¤±è´¥') : 'â³ å¾…æµ‹è¯•';

            return `
                <div class="test-card" id="test-${test.id}">
                    <div class="test-header">
                        <div class="test-title">${test.title}</div>
                        <div class="status ${statusClass}" id="status-${test.id}">${statusText}</div>
                    </div>
                    <div class="test-details" id="details-${test.id}">${result ? result.message : 'ç­‰å¾…è¿è¡Œ...'}</div>
                </div>
            `;
        }

        function updateTest(test, result) {
            const statusEl = document.getElementById(`status-${test.id}`);
            const detailsEl = document.getElementById(`details-${test.id}`);

            if (result.passed) {
                statusEl.className = 'status passed';
                statusEl.textContent = 'âœ“ é€šè¿‡';
            } else {
                statusEl.className = 'status failed';
                statusEl.textContent = 'âœ— å¤±è´¥';
            }

            detailsEl.textContent = result.message;
        }

        function updateSummary() {
            const total = tests.length;
            const passed = Object.values(testResults).filter(r => r.passed).length;
            const failed = Object.values(testResults).filter(r => !r.passed).length;

            document.getElementById('totalTests').textContent = total;
            document.getElementById('passedTests').textContent = passed;
            document.getElementById('failedTests').textContent = failed;
        }

        async function runTest(test) {
            updateTest(test, { message: 'è¿è¡Œä¸­...', passed: false });

            const statusEl = document.getElementById(`status-${test.id}`);
            statusEl.className = 'status running';
            statusEl.textContent = 'â³ è¿è¡Œä¸­';

            try {
                const result = await test.run();
                testResults[test.id] = result;
                updateTest(test, result);
            } catch (e) {
                testResults[test.id] = { passed: false, message: `æµ‹è¯•å¼‚å¸¸: ${e.message}` };
                updateTest(test, testResults[test.id]);
            }

            updateSummary();
        }

        async function runAllTests() {
            // é‡ç½®
            testResults = {};
            document.getElementById('testResults').innerHTML = tests.map(t => renderTest(t)).join('');
            updateSummary();

            // ä¾æ¬¡è¿è¡Œæµ‹è¯•
            for (const test of tests) {
                await runTest(test);
                // æ·»åŠ å°å»¶è¿Ÿï¼Œè®©UIæ›´æ–°
                await new Promise(resolve => setTimeout(resolve, 100));
            }

            // æ˜¾ç¤ºå®Œæˆæç¤º
            const passed = Object.values(testResults).filter(r => r.passed).length;
            const total = tests.length;
            alert(`æµ‹è¯•å®Œæˆï¼\né€šè¿‡: ${passed}/${total}\n\nè¯·æŸ¥çœ‹è¯¦ç»†ç»“æœï¼Œç¡®ä¿æ‰€æœ‰æµ‹è¯•éƒ½é€šè¿‡ã€‚`);
        }

        // é¡µé¢åŠ è½½æ—¶æ¸²æŸ“æµ‹è¯•åˆ—è¡¨
        document.getElementById('testResults').innerHTML = tests.map(t => renderTest(t)).join('');
        document.getElementById('totalTests').textContent = tests.length;
    </script>
</body>
</html>
